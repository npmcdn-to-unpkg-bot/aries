"undefined"==typeof Videos&&(Videos={}),Videos.Explorer=Garnish.Base.extend({playerModal:null,searchTimeout:null,init:function(e,t){this.settings=t,this.$container=e;var s={namespaceInputId:this.settings.namespaceInputId};Craft.postActionRequest("videos/getExplorerModal",s,$.proxy(function(e,t){this.$modal=$(e).appendTo(this.$container),this.$main=$(".main",this.$modal),this.$spinner=$(".spinner",this.$modal),this.$gateways=$(".gateways select",this.$modal),this.$sectionLinks=$("nav a",this.$modal),this.$search=$(".search",this.$modal),this.$mainContent=$(".main .content",this.$modal),this.$videos=$(".videos",this.$modal),this.$scroller=this.$main,this.addListener(this.$sectionLinks,"click",$.proxy(function(e){this.$sectionLinks.filter(".sel").removeClass("sel"),$(e.currentTarget).addClass("sel"),gateway=$(e.currentTarget).data("gateway"),method=$(e.currentTarget).data("method"),options=$(e.currentTarget).data("options"),"undefined"!=typeof options&&(options=JSON.stringify(options),options=$.parseJSON(options)),this.getVideos(gateway,method,options),e.preventDefault()},this)),this.addListener(this.$search,"textchange",$.proxy(function(e){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout($.proxy(this,"search",e),500)},this)),this.addListener(this.$search,"blur",$.proxy(function(e){var t=$(e.currentTarget).val();0==t.length&&this.$sectionLinks.filter(".sel").trigger("click")},this)),this.addListener(this.$search,"keypress",function(e){e.keyCode==Garnish.RETURN_KEY&&(e.preventDefault(),this.search(e))}),Craft.initUiElements(),$("nav div:not(.hidden) a:first",this.$modal).trigger("click")},this))},search:function(e){q=$(e.currentTarget).val(),q.length>0?(gateway=this.$gateways.val(),method="search",options={q:q},this.getVideos(gateway,method,options)):this.$videos.html("")},playVideo:function(e){var t=$(e.currentTarget).data("gateway"),s=$(e.currentTarget).data("id");this.playerModal?this.playerModal.show():this.playerModal=new Videos.Player({gateway:t,videoId:s,onHide:$.proxy(function(){this.settings.onPlayerHide()},this)}),this.settings.onPlayerShow(),this.playerModal.play({gateway:t,videoId:s})},selectVideo:function(e){this.$videoElements.removeClass("sel"),$(e.currentTarget).addClass("sel"),url=$(e.currentTarget).data("url"),this.settings.onSelectVideo(url)},getVideos:function(e,t,s){this.removeListener(this.$scroller,"scroll"),data={gateway:e,method:t,options:s},this.$spinner.removeClass("hidden"),Craft.postActionRequest("videos/getVideos",data,$.proxy(function(i,o){if(this.deselectVideos(),this.$spinner.addClass("hidden"),this.$videos.html(""),"success"==o)if(i.error)this.$mainContent.html('<p class="error">'+i.error+"</p>");else if($(".error",this.$mainContent).remove(),this.$videos=$('<div class="videos" />'),this.$videos.html(i.html),this.$mainContent.append(this.$videos),this.$playBtns=$(".play",this.$videos),this.$videoElements=$(".video",this.$videos),this.addListener(this.$playBtns,"click","playVideo"),this.addListener(this.$videoElements,"click","selectVideo"),i.more){if($moreBtn=$('<a class="more btn">More</a>'),this.$videos.append($moreBtn),"undefined"==typeof s)var n={};else var n=s;n.moreToken=i.moreToken,this.addListener($moreBtn,"click",$.proxy(function(){this.loadMore(e,t,n)},this)),this.addListener(this.$scroller,"scroll",$.proxy(function(){this.maybeLoadMore(e,t,n)},this))}$(".main",this.$modal).animate({scrollTop:0},0)},this))},maybeLoadMore:function(e,t,s){this.canLoadMore()&&this.loadMore(e,t,s)},canLoadMore:function(){var e=this.$scroller.prop("scrollHeight"),t=this.$scroller.scrollTop(),s=this.$scroller.outerHeight();return s+15>=e-t},loadMore:function(e,t,s){this.removeListener(this.$scroller,"scroll"),$(".more",this.$videos).remove(),this.$spinner.removeClass("hidden"),$videosSpinner=$('<div class="spinner" />'),this.$videos.append($videosSpinner),data={gateway:e,method:t,options:s},Craft.postActionRequest("videos/getVideos",data,$.proxy(function(i,o){if(this.deselectVideos(),this.$spinner.addClass("hidden"),$videosSpinner.remove(),"success"==o)if("undefined"==typeof i.error){if(this.$videos.append(i.html),this.$playBtns=$(".play",this.$videos),this.$videoElements=$(".video",this.$videos),this.addListener(this.$playBtns,"click","playVideo"),this.addListener(this.$videoElements,"click","selectVideo"),i.more){if($moreBtn=$('<a class="more btn">More</a>'),this.$videos.append($moreBtn),"undefined"==typeof s)var n={};else var n=s;n.moreToken=i.moreToken,this.addListener($moreBtn,"click",$.proxy(function(){this.loadMore(e,t,s)},this)),this.addListener(this.$scroller,"scroll",$.proxy(function(){this.maybeLoadMore(e,t,n)},this))}}else this.$videos.html('<p class="error">'+i.error+"</p>")},this))},deselectVideos:function(){this.$videoElements&&(currentVideo=this.$videoElements.filter(".sel"),currentVideo.removeClass(".sel"),this.settings.onDeselectVideo())}});